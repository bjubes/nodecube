<div id="login">
    <form id="login-form">
        Username: <input id="login-username" type="text" placeholder="name"></input><br>
        <input id="play-btn" type="submit" value="Go!"></input>
    </form>
</div>
<div id="game" style="display:none">
    <canvas id="ctx" width="500" height="500" style="border:1px solid #000000;"></canvas>

    <div id="chat-text" style="width:500px;height:100px;overflow-y:scroll">
        <div>Type below to chat!</div>
    </div>

    <form id="chat-form">
        <input id="chat-input" type="text" style="width:500px"></input>
    </form>
</div>

<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script>
    var socket = io();

    //login
    var loginDiv = document.getElementById('login');
    var loginForm = document.getElementById('login-form')
    var loginUsername = document.getElementById('login-username');
    var gameDiv = document.getElementById('game');

    loginForm.onsubmit = function(e){
        e.preventDefault();
        socket.emit('login',{name:loginUsername.value});
        loginUsername.value = '';
    }

    socket.on('loginResponse',function(data){
        if(data.success){
            loginDiv.style.display = 'none';
            gameDiv.style.display = 'inline-block';
        } else {
            alert("Sign in unsuccessul.");
        }
    });

	//chat
	var chatText = document.getElementById('chat-text');
	var chatInput = document.getElementById('chat-input');
	var chatForm = document.getElementById('chat-form');


	var size = 50;
	var ctx = document.getElementById("ctx").getContext("2d");
	ctx.font = '30px Arial';


    //game
    var playerList = {}
    class Player {
        constructor(initPackage){
            this.name = initPackage.name;
            this.id = initPackage.id;
            this.x = initPackage.x;
            this.y = initPackage.y;
            this.color = initPackage.color;
            //bookkeeping
            playerList[this.id] = this;
        }
    }

    //collection of {id: color}

    //this is sent to existing players when a new player joins and
    //to a new player to tell them about existing players
    socket.on('newPlayer', function(initPackages){
        for(var i in initPackages){
            var initPackage = initPackages[i]
            new Player(initPackage)
        }
    })

	socket.on('update',function(delta){
        //delta is {players: [{id,x,y},{id,x,y}]}
        for(var i = 0; i < delta.players.length; i++){
            var newInfo = delta.players[i];
            if (!(newInfo.id in playerList)) {
                //we got an update about a player we don't know about
                //TODO: request this players init
                continue;
            }
            var player = playerList[newInfo.id]
            //update every value in player that exists in the deltapack
            for(key in newInfo){
                //except id
                if(key == "id") {continue;}
                player[key] = newInfo[key]
            }
            // save changes
            playerList[newInfo.id] = player;
        }
    });

    //update screen every frame based on locally cached information
    setInterval(function(){
		ctx.clearRect(0,0,500,500);
		for(var i in playerList) {
			var player = playerList[i];
            ctx.fillStyle = player.color;
			ctx.fillRect(player.x - size/2, player.y - size/2, size, size);
		}
	}, 1000/25);

	socket.on('playerDisconnect', function(data){
		delete playerList[data.id];
	})


	//keyboard events
	document.onkeydown = function(event){
		//TODO: bail if user is focused on chat
	   if(event.keyCode === 68)    //d
		   socket.emit('keyPress',{dir:0});
	   else if(event.keyCode === 87) // w
		 socket.emit('keyPress',{dir:1});
	   else if(event.keyCode === 65) //a
		   socket.emit('keyPress',{dir:2});
	   else if(event.keyCode === 83)   //s
		 socket.emit('keyPress',{dir:3});
   }


   //chat
   socket.on('addToChat',function(data){
	   chatText.innerHTML += '<div><b>' + data.name + ':</b> ' + data.msg +'</div>';
   });
   socket.on('evalResponse',function(data){
	   console.log(data);
   });


   chatForm.onsubmit = function(e){
	   e.preventDefault();
	   if(chatInput.value[0] === '/')
		   socket.emit('evalServer',chatInput.value.slice(1));
	   else
		   socket.emit('chatToServer',chatInput.value);
	   chatInput.value = '';
   }


</script>
