<canvas id="ctx" width="500" height="500" style="border:1px solid #000000;"></canvas>

<div id="chat-text" style="width:500px;height:100px;overflow-y:scroll">
    <div>Hello!</div>
</div>

<form id="chat-form">
    <input id="chat-input" type="text" style="width:500px"></input>
</form>

<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script>
	//chat
	var chatText = document.getElementById('chat-text');
	var chatInput = document.getElementById('chat-input');
	var chatForm = document.getElementById('chat-form');


	var size = 50;
	var ctx = document.getElementById("ctx").getContext("2d");
	ctx.font = '30px Arial';

	var socket = io();
	//collection of {id: color}
	var playerList = {}

	socket.on('newPositions',function(data){
		ctx.clearRect(0,0,500,500);
		for(var i = 0 ; i < data.length; i++) {
			var player = data[i];
			ctx.fillRect(player.x - size/2, player.y - size/2, size, size);
			//color logic
		 	if (player.id in playerList) {
				ctx.fillStyle = playerList[player.id].color;
			} else
			{
				//actually populating the list is dealt with by colorOfPlayerResponse
				socket.emit('colorOfPlayer', player.id);
				//set it to undefined so we don't query server multiple times
				playerList[player.id] = {color:"#000000"};
			}
		}


	});

	socket.on('colorOfPlayerResponse', function(player){
		playerList[player.id].color = player.color;
	})

	socket.on('playerDisconnect', function(data){
		delete playerList[data.id];
	})


	//keyboard events
	document.onkeydown = function(event){
	   if(event.keyCode === 68)    //d
		   socket.emit('keyPress',{dir:0});
	   else if(event.keyCode === 87) // w
		 socket.emit('keyPress',{dir:1});
	   else if(event.keyCode === 65) //a
		   socket.emit('keyPress',{dir:2});
	   else if(event.keyCode === 83)   //s
		 socket.emit('keyPress',{dir:3});
   }


   //chat
   socket.on('addToChat',function(data){
	   chatText.innerHTML += '<div><b>' + data.name + ':</b> ' + data.msg +'</div>';
   });
   socket.on('evalResponse',function(data){
	   console.log(data);
   });


   chatForm.onsubmit = function(e){
	   e.preventDefault();
	   if(chatInput.value[0] === '/')
		   socket.emit('evalServer',chatInput.value.slice(1));
	   else
		   socket.emit('chatToServer',chatInput.value);
	   chatInput.value = '';
   }


</script>
