<div id="login">
    <form id="login-form">
        Username: <input id="login-username" type="text" placeholder="name"></input><br>
        <input id="play-btn" type="submit" value="Go!"></input>
    </form>
</div>
<div id="game" style="display:none">
    <canvas id="ctx" width="500" height="500" style="border:1px solid #000000;"></canvas>

    <div id="chat-text" style="width:500px;height:100px;overflow-y:scroll">
        <div>Type below to chat!</div>
    </div>

    <form id="chat-form">
        <input id="chat-input" type="text" style="width:500px"></input>
    </form>
</div>

<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script>
    var socket = io();

    //login
    var loginDiv = document.getElementById('login');
    var loginForm = document.getElementById('login-form')
    var loginUsername = document.getElementById('login-username');
    var gameDiv = document.getElementById('game');

    loginForm.onsubmit = function(e){
        e.preventDefault();
        socket.emit('login',{name:loginUsername.value});
        loginUsername.value = '';
        console.log(loginUsername.value)
    }

    socket.on('loginResponse',function(data){
        if(data.success){
            loginDiv.style.display = 'none';
            gameDiv.style.display = 'inline-block';
        } else {
            alert("Sign in unsuccessul.");
        }
    });

	//chat
	var chatText = document.getElementById('chat-text');
	var chatInput = document.getElementById('chat-input');
	var chatForm = document.getElementById('chat-form');


	var size = 50;
	var ctx = document.getElementById("ctx").getContext("2d");
	ctx.font = '30px Arial';

	//collection of {id: color}
	var playerList = {}

	socket.on('newPositions',function(data){
		ctx.clearRect(0,0,500,500);
		for(var i = 0 ; i < data.length; i++) {
			var player = data[i];
			ctx.fillRect(player.x - size/2, player.y - size/2, size, size);
			//color logic
		 	if (player.id in playerList) {
				ctx.fillStyle = playerList[player.id].color;
			} else
			{
				//actually populating the list is dealt with by colorOfPlayerResponse
				socket.emit('colorOfPlayer', player.id);
				//set it to undefined so we don't query server multiple times
				playerList[player.id] = {color:"#000000"};
			}
		}
	});

	socket.on('colorOfPlayerResponse', function(player){
        if (!(player.id in playerList)) {
            playerList[player.id] = {}
        }
		playerList[player.id].color = player.color;
	})

	socket.on('playerDisconnect', function(data){
		delete playerList[data.id];
	})


	//keyboard events
	document.onkeydown = function(event){
		//TODO: bail if user is focused on chat
	   if(event.keyCode === 68)    //d
		   socket.emit('keyPress',{dir:0});
	   else if(event.keyCode === 87) // w
		 socket.emit('keyPress',{dir:1});
	   else if(event.keyCode === 65) //a
		   socket.emit('keyPress',{dir:2});
	   else if(event.keyCode === 83)   //s
		 socket.emit('keyPress',{dir:3});
   }


   //chat
   socket.on('addToChat',function(data){
	   chatText.innerHTML += '<div><b>' + data.name + ':</b> ' + data.msg +'</div>';
   });
   socket.on('evalResponse',function(data){
	   console.log(data);
   });


   chatForm.onsubmit = function(e){
	   e.preventDefault();
	   if(chatInput.value[0] === '/')
		   socket.emit('evalServer',chatInput.value.slice(1));
	   else
		   socket.emit('chatToServer',chatInput.value);
	   chatInput.value = '';
   }


</script>
